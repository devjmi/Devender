<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Premium Calculator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Keyframes for the blinking effect */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Class to apply the animation */
        .blinking {
            animation: blink 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 relative">

    <!-- Background Image Container with Overlay -->
    <div class="absolute inset-0 z-0" style="background-image: url('https://i.ibb.co/vxjgt2Dk/Whats-App-Image-2025-08-14-at-4-45-52-PM-89.jpg'); background-size: contain; background-position: center; background-repeat: no-repeat;">
        <!-- Semi-transparent dark overlay for readability -->
        <div class="absolute inset-0 bg-black opacity-50"></div>
    </div>

    <!-- Buttons Container -->
    <div class="z-10 relative flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 p-4 w-full justify-center items-center">
        <!-- Button to open the calculator -->
        <button id="openCalculatorBtn" class="bg-blue-600 text-white font-bold text-xs px-1 py-0.5 rounded-full shadow-lg hover:bg-blue-700 transition-colors transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 w-full md:w-auto blinking">
            Open Premium and Commission Calculator
        </button>
        <!-- Button for "Contact Us" linking to WhatsApp -->
        <a href="https://api.whatsapp.com/send?phone=9289719341" target="_blank" class="bg-green-600 text-white font-bold text-xs px-1 py-0.5 rounded-full shadow-lg hover:bg-green-700 transition-colors transform hover:scale-105 flex items-center justify-center w-full md:w-auto blinking">
            Contact Us
        </a>
    </div>

    <!-- Calculator Container - initially hidden and centered -->
    <div id="calculatorContainer" class="bg-white p-3 rounded-lg shadow-lg w-full max-w-64 z-10 relative hidden">
        
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-lg font-extrabold text-blue-800 mb-1">Bus Premium Calculator</h1>
        </div>

        <!-- Input Form -->
        <form id="premiumForm" class="space-y-2">

            <!-- IDV -->
            <div>
                <label for="idv" class="block text-xs font-medium text-gray-700">Insured Declared Value (IDV) in ₹</label>
                <input type="number" id="idv" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g., 500000" required>
            </div>

            <!-- Seating & Personnel Details Row -->
            <div class="grid grid-cols-2 gap-2">
                <!-- Seating Capacity -->
                <div>
                    <label for="seatingCapacity" class="block text-xs font-medium text-gray-700">Seating Capacity</label>
                    <input type="number" id="seatingCapacity" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g., 40" required>
                </div>
                <!-- Paid Drivers -->
                <div>
                    <label for="paidDrivers" class="block text-xs font-medium text-gray-700">No. of Paid Drivers</label>
                    <input type="number" id="paidDrivers" value="1" min="0" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                </div>
            </div>

            <!-- NCB & Discount Row -->
            <div class="grid grid-cols-2 gap-2">
                <!-- NCB Percentage -->
                <div>
                    <label for="ncb" class="block text-xs font-medium text-gray-700">No Claim Bonus (NCB) %</label>
                    <select id="ncb" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                        <option value="0">0%</option>
                        <option value="20">20%</option>
                        <option value="25">25%</option>
                        <option value="35">35%</option>
                        <option value="45">45%</option>
                        <option value="50">50%</option>
                    </select>
                </div>
                <!-- Company Discount -->
                <div>
                    <label for="companyDiscount" class="block text-xs font-medium text-gray-700">Company Discount</label>
                    <select id="companyDiscount" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                        <option value="none">No Discount</option>
                        <option value="digit">Digit (99%)</option>
                        <option value="tata">TATA AIG (95%)</option>
                        <option value="reliance">Reliance General (95%)</option>
                    </select>
                </div>
            </div>
            
            <!-- Fuel Type Checkbox -->
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="cngFuel" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="cngFuel" class="text-xs font-medium text-gray-700">CNG Fuel Type</label>
            </div>

            <!-- Calculate Button -->
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                Calculate
            </button>
        </form>

        <!-- Results Section -->
        <div id="results" class="mt-3 hidden">
            <h2 class="text-sm font-bold text-gray-800 mb-2">Premium Breakdown</h2>
            <div class="space-y-1 p-3 bg-gray-50 rounded-md border border-gray-200 text-xs">
                <div class="flex justify-between items-center text-gray-600">
                    <span>Own Damage (OD) Premium</span>
                    <span id="odPremium" class="font-semibold text-gray-800"></span>
                </div>
                <div id="cngOdPremiumSection" class="flex justify-between items-center text-gray-600 hidden">
                    <span>CNG Premium</span>
                    <span id="cngOdPremiumAmount" class="font-semibold"></span>
                </div>
                <div class="flex justify-between items-center text-gray-600">
                    <span>Third-Party (TP) Liability Premium</span>
                    <span id="tpPremium" class="font-semibold text-gray-800"></span>
                </div>
                <div class="flex justify-between items-center text-gray-600">
                    <span>Legal Liability to Paid Driver</span>
                    <span id="llPremium" class="font-semibold text-gray-800"></span>
                </div>
                <div class="flex justify-between items-center text-gray-600">
                    <span>IMT 23</span>
                    <span id="imt23Premium" class="font-semibold text-gray-800"></span>
                </div>
                <div id="towingChargeSection" class="flex justify-between items-center text-gray-600 hidden">
                    <span>Towing Charge</span>
                    <span id="towingChargePremium" class="font-semibold text-gray-800"></span>
                </div>
                <div id="cngTpPremiumSection" class="flex justify-between items-center text-gray-600 hidden">
                    <span>CNG TP Premium</span>
                    <span id="cngTpPremiumAmount" class="font-semibold"></span>
                </div>
                <div class="flex justify-between items-center text-green-600">
                    <span id="companyDiscountLabel">Company Discount</span>
                    <span id="companyDiscountAmount" class="font-semibold">- ₹0.00</span>
                </div>
                <hr class="border-t border-gray-300">
                <div class="flex justify-between items-center text-gray-600 font-semibold text-gray-800">
                    <span>GST (18%)</span>
                    <span id="gstAmount" class="font-semibold text-gray-800"></span>
                </div>
                <hr class="border-t border-gray-300">
                <div class="flex justify-between items-center text-sm font-bold text-gray-800">
                    <span>Total Premium (with GST)</span>
                    <span id="totalPremium" class="text-blue-600"></span>
                </div>
            </div>
            
            <!-- Commission Breakdown Toggle Button -->
            <button id="toggleCommissionBtn" class="w-full text-left font-bold text-white mt-3 py-2 px-3 flex justify-between items-center bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                <span>Commission Breakdown</span>
                <span id="commissionToggleIcon">▶</span>
            </button>
        </div>
    </div>
    
    <!-- Commission Breakdown Modal -->
    <div id="commissionModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm relative">
            <!-- Modal Header and Close Button -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">Commission Breakdown</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Commission Rate Input within the modal -->
            <div class="mb-4">
                <label for="commissionRate" class="block text-sm font-medium text-gray-700">Commission Rate %</label>
                <input type="number" id="commissionRate" value="15" min="0" max="100" class="mt-1 p-2 border border-gray-300 rounded-md w-full text-xs focus:ring-green-500 focus:border-green-500 transition-colors" required>
            </div>

            <!-- Commission Results Section -->
            <div id="commissionSection" class="space-y-1 p-3 bg-gray-100 rounded-md border border-gray-300 text-xs">
                <div class="flex justify-between items-center text-gray-600">
                    <span>Basic Commission (<span id="commissionRateDisplay">15</span>% of Premium before GST)</span>
                    <span id="basicCommission" class="font-semibold text-gray-800"></span>
                </div>
                <div class="flex justify-between items-center text-gray-600">
                    <span>TDS on Commission (2%)</span>
                    <span id="tdsOnCommission" class="font-semibold text-gray-800"></span>
                </div>
                <hr class="border-t border-gray-300">
                <div class="flex justify-between items-center text-sm font-bold text-gray-800">
                    <span>Net Commission</span>
                    <span id="totalCommission" class="text-green-600"></span>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript for Calculations -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const openCalculatorBtn = document.getElementById('openCalculatorBtn');
            const calculatorContainer = document.getElementById('calculatorContainer');

            // Handle showing the calculator
            openCalculatorBtn.addEventListener('click', function() {
                openCalculatorBtn.classList.add('hidden');
                calculatorContainer.classList.remove('hidden');
            });
            
            // Handle hiding the calculator when clicking outside of it
            document.body.addEventListener('click', function(event) {
                // Check if the calculator is visible and the click is outside
                if (!calculatorContainer.classList.contains('hidden') && !calculatorContainer.contains(event.target) && event.target !== openCalculatorBtn) {
                    calculatorContainer.classList.add('hidden');
                    openCalculatorBtn.classList.remove('hidden');
                }
            });
            
            // Commission breakdown modal functionality
            const toggleCommissionBtn = document.getElementById('toggleCommissionBtn');
            const commissionModal = document.getElementById('commissionModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            
            toggleCommissionBtn.addEventListener('click', function() {
                commissionModal.classList.remove('hidden');
                // Ensure the commission is calculated and displayed when the modal opens
                calculateAndDisplayCommission();
            });

            closeModalBtn.addEventListener('click', function() {
                commissionModal.classList.add('hidden');
            });
        });

        document.getElementById('premiumForm').addEventListener('submit', function(event) {
            // Prevent the default form submission
            event.preventDefault();
            
            // This function handles the main premium calculation and displays it
            calculateAndDisplayPremium();
        });

        // Event listener for the commission rate input inside the modal
        document.getElementById('commissionRate').addEventListener('input', function() {
            // Recalculate and display the commission whenever the rate changes
            calculateAndDisplayCommission();
        });

        function calculateAndDisplayPremium() {
            const idv = parseFloat(document.getElementById('idv').value);
            const seatingCapacity = parseInt(document.getElementById('seatingCapacity').value);
            const paidDrivers = parseInt(document.getElementById('paidDrivers').value);
            const licensedPassengers = seatingCapacity - 1;
            const ncb = parseInt(document.getElementById('ncb').value);
            const selectedCompany = document.getElementById('companyDiscount').value;
            const isCngFuel = document.getElementById('cngFuel').checked;

            // --- Own Damage (OD) Premium Calculation ---
            const odRate = 1.739;
            const basicOdPremium = idv * (odRate / 100);

            let loadingPremium;
            if (seatingCapacity <= 19) {
                loadingPremium = 350;
            } else if (seatingCapacity >= 20 && seatingCapacity <= 37) {
                loadingPremium = 450;
            } else {
                loadingPremium = 550;
            }
            
            // --- CNG OD Premium Add-on ---
            const cngOdPremiumRate = 0.05;
            let cngOdPremium = isCngFuel ? basicOdPremium * cngOdPremiumRate : 0;
            
            // --- Sum of all OD-related premiums before discounts ---
            const odPremiumBeforeNcb = basicOdPremium + loadingPremium + cngOdPremium;
            
            // --- Apply NCB to the total OD premium ---
            const ncbDiscount = odPremiumBeforeNcb * (ncb / 100);
            const odPremiumAfterNcb = odPremiumBeforeNcb - ncbDiscount;
            
            // --- IMT 23 Premium Calculation (0.15% of the OD premium after NCB) ---
            const imt23Rate = 0.15;
            const imt23PremiumBeforeDiscount = odPremiumAfterNcb * imt23Rate;

            // --- Company Discount Logic ---
            let discountRate = 0;
            let discountLabelText = 'Company Discount';
            let towingCharge = 0;
            
            if (selectedCompany === 'digit') {
                discountRate = 0.99;
                discountLabelText = 'Company Discount (99%)';
            } else if (selectedCompany === 'tata' || selectedCompany === 'reliance') {
                discountRate = 0.95;
                if (selectedCompany === 'reliance') {
                    discountLabelText = 'Company Discount (95%)';
                    towingCharge = 500;
                } else {
                    discountLabelText = 'Company Discount (95%)';
                }
            }

            // --- Apply company discount to each component separately for the breakdown ---
            const odPremiumAfterCompanyDiscount = odPremiumAfterNcb * (1 - discountRate);
            const imt23PremiumAfterCompanyDiscount = imt23PremiumBeforeDiscount * (1 - discountRate);

            // Calculate the total discount amount
            const companyDiscountAmount = (odPremiumAfterNcb + imt23PremiumBeforeDiscount) * discountRate;

            // --- Third-Party (TP) Liability Premium Calculation ---
            const basicTpPremium = 12192;
            const paidDriverPremium = paidDrivers * 50;
            const licensedPassengerPremium = licensedPassengers * 745;
            const totalTpPremium = basicTpPremium + paidDriverPremium + licensedPassengerPremium - 50;
            
            // --- Legal Liability Premium ---
            const llPremium = 50;

            // --- CNG TP Premium ---
            let cngTpPremium = 0;
            if (isCngFuel) {
                cngTpPremium = 60;
            }
            
            // --- Total Premium Before GST ---
            const totalPremiumBeforeGst = odPremiumAfterCompanyDiscount + imt23PremiumAfterCompanyDiscount + totalTpPremium + llPremium + towingCharge + cngTpPremium;
            
            // --- GST Calculation (18%) ---
            const gstAmount = totalPremiumBeforeGst * 0.18;
            const finalTotalPremiumWithGst = totalPremiumBeforeGst + gstAmount;

            // Display results in the HTML
            document.getElementById('odPremium').textContent = formatCurrency(odPremiumAfterCompanyDiscount);
            document.getElementById('tpPremium').textContent = formatCurrency(totalTpPremium);
            document.getElementById('llPremium').textContent = formatCurrency(llPremium);
            document.getElementById('imt23Premium').textContent = formatCurrency(imt23PremiumAfterCompanyDiscount);
            document.getElementById('companyDiscountLabel').textContent = discountLabelText;
            document.getElementById('companyDiscountAmount').textContent = formatCurrency(companyDiscountAmount, true);
            document.getElementById('gstAmount').textContent = formatCurrency(gstAmount);
            document.getElementById('totalPremium').textContent = formatCurrency(finalTotalPremiumWithGst);
            
            // Display towing charge only if applicable
            const towingChargeSection = document.getElementById('towingChargeSection');
            if (towingCharge > 0) {
                towingChargeSection.classList.remove('hidden');
                document.getElementById('towingChargePremium').textContent = formatCurrency(towingCharge);
            } else {
                towingChargeSection.classList.add('hidden');
            }

            // Display CNG TP Premium only if applicable
            const cngTpPremiumSection = document.getElementById('cngTpPremiumSection');
            if (cngTpPremium > 0) {
                cngTpPremiumSection.classList.remove('hidden');
                document.getElementById('cngTpPremiumAmount').textContent = formatCurrency(cngTpPremium);
            } else {
                cngTpPremiumSection.classList.add('hidden');
            }

            // Display CNG OD Premium after discount only if applicable
            const cngOdPremiumSection = document.getElementById('cngOdPremiumSection');
            if (isCngFuel) {
                cngOdPremiumSection.classList.remove('hidden');
                // Display the discounted CNG premium amount
                document.getElementById('cngOdPremiumAmount').textContent = formatCurrency(cngOdPremium * (1 - discountRate));
            } else {
                cngOdPremiumSection.classList.add('hidden');
            }

            // Show the results section
            document.getElementById('results').classList.remove('hidden');

            // Store the premium before GST for commission calculation
            window.totalPremiumBeforeGst = totalPremiumBeforeGst;
        }

        function calculateAndDisplayCommission() {
            // Read premium before GST from the stored variable
            const totalPremiumBeforeGst = window.totalPremiumBeforeGst || 0;
            const commissionRateInput = parseFloat(document.getElementById('commissionRate').value);
            
            // --- Commission Calculation ---
            const commissionRate = commissionRateInput / 100;
            const basicCommission = totalPremiumBeforeGst * commissionRate;
            const tdsRate = 0.02;
            const tdsOnCommission = basicCommission * tdsRate;
            const totalCommission = basicCommission - tdsOnCommission;
            
            // Display commission details in the modal
            document.getElementById('commissionRateDisplay').textContent = commissionRateInput;
            document.getElementById('basicCommission').textContent = formatCurrency(basicCommission);
            document.getElementById('tdsOnCommission').textContent = formatCurrency(tdsOnCommission);
            document.getElementById('totalCommission').textContent = formatCurrency(totalCommission);
        }


        // Helper function to format numbers as Indian Rupees
        function formatCurrency(amount, isDiscount = false) {
            const formatter = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
            });

            if (isDiscount) {
                return `- ${formatter.format(amount).replace('₹', '')}`;
            } else {
                return formatter.format(amount);
            }
        }
    </script>
</body>
</html>
